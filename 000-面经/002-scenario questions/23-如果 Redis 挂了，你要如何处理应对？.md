我曾听到过一个技术面试中的经典问答，是关于 Redis 相关的面试题，大家一起来看下。



## 面试场景

面试官：“如果你项目中的 Redis 集群整个都挂了，这时你要如何处理应对呢？”

候选人：“这个没关系的，因为 Redis 有 RDB 和 AOF 两种持久化方式，在 Redis 4.0 以后还支持 RDB + AOF 的混合持久化，所以挂了也没事。等 Redis 集群重启之后，数据是可以很快恢复过来的。”

候选人说完后，习惯性地用手摸摸后脑，似乎对自己的回答很满意。

面试官解释道：“我的意思是，如果 Redis 集群挂了，那系统中所有请求就都落在数据库上了，数据库应该也很快会被打挂吧。而一旦数据库挂了，那系统就整体不可用了。”

候选人明显有些慌乱，解释道：“哦，没事的，我们系统的 QPS 没有那么高，不会把数据库打挂的。”

面试官：“既然你们系统中的 QPS 没这么高，那为什么要用 Redis 来扛请求呢？”

候选人：“这。。。。。。”

面试官：“另外，就算把 Redis 集群中的数据恢复了，大概率也不能用了。因为在 Redis 集群挂了的这个时间段，仍然会有很多数据修改或删除的请求打过来，Redis 集群中的数据并没有随之进行更改或删除，那就会出现脏数据的情况。”

候选人想了十秒钟，说道：“嗯嗯，是的，我确实没考虑到这个问题。”

从对话中我们可以看出来，候选人的答案并不是面试官想要的。

如果大家看过我在前文中写的《提升可用性三部曲》就应该知道，面试官希望听到的是，当 Redis 集群挂了的时候，候选人如何从保障系统可用性的角度，给出范围可控且快速止损的解决方案，而绝不仅仅是给出一个“Redis 持久化”相关知识的八股文。

<p align=center><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b618bcba094b4f7583ec0c6eb7231f1c~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1117&h=512&s=96079&e=png&b=fffbfb" alt="image.png"  /></p>



接下来我们言归正传，说下 “Redis 集群挂了” 这个场景的整体处理步骤，可能会比大家所认知的要复杂一些，但还是比较容易理解的。



## 1. 启动限流降级

当“Redis 集群挂了”的情况下，我们需要迅速启用限流或降级策略，把系统接收请求的数量和质量，控制在其所能承载处理的范围之内。说白了就是，让失去 Redis 集群支撑的业务系统，不要被外部流量直接击垮。

下面我们再稍微回顾一下限流和降级。



### 限流

限流的目的，旨在保护系统不被超出其处理能力的请求冲垮，通过拒绝请求的方式，保证系统的可用性。

<p align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2ea1a8e448a040c59b8e5652ad37a4fb~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=495&h=381&s=56681&e=png&b=ffffff" alt=""  /></p>



其实限流的理念，在我们日常生活中也经常会用到，如果有在“北上广深”一线城市待过的同学，一定经历过地铁限流情况。再有就是一些城市热门景区景点的游客限流，比如口罩期间，故宫每天的限制游客量是 3000 人，等等。

《提升可用性三部曲》的文章中已经说了，限流的关键点在于其限流阈值设置上。

探究系统合理阈值的方式，还是在系统的业务低峰期，以真实流量回放、并递增加压的方式（1 倍、1.5 倍、2 倍、2.5 倍、3 倍等）进行压测，探查系统所能承载的最大容量，然后将限流阈值设置为其峰值容量的 50%～70%。

因此，如果我们所负责的系统重要、等级足够高的话，是需要专门压测“Redis 集群挂了”这个场景的，以此得出一个合理的压测阈值出来。

### 降级

服务降级，是指当系统出现高负载或异常时，通过牺牲部分非核心功能的方式，保证系统核心功能的可用性。这是一种“弃车保帅”的策略。

<p align=center><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/86ba2347febd4a578a3311975999a78f~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=630&h=404&s=47779&e=png&b=ffffff" alt=""  /></p>



另外，“Redis 集群挂了”这个场景的降级策略，我们需要通过配置中心以修改参数的方式操作降级，而不是现场修改业务代码进行 Hotfix 的方式。

这点一定要切记，否则会把一个本应不存在的故障拖到真实发生。 

我们再来说说，如何在“降级”和“限流”之间进行选择。

- 如果系统中接口的重要等级非常分明的情况下，我们尽量选择通过“降级”的策略来解决问题。
- 如果系统中接口的重要等级并不分明，我们就索性简单直接地走“限流”的策略好了。



## 2. 空集群预热

之前我们说了，在“Redis 集群挂了”这个时间段，仍然会有很多数据修改的请求打过来，Redis 集群中的数据并没有随之更改或删除，那就会出现脏数据的情况。

这种情况下，我们需要将一个空的 Redis 集群，投入到生产环境的使用中，通过将用户实时请求的数据吃进缓存方式将其慢慢预热。

切记，此时不要把限流或降级一下子放开，因为当前形同虚设的空 Redis 集群，还不能起到保护数据库的作用，数据库容易被瞬间激增的流量打挂。

当然，也有例外的情况，就是该系统存储到 Redis 中的数据只有添加和查询操作，并没有修改和删除操作。这种情况下，可以把挂了的 Redis 集群直接进行数据恢复，恢复完成后即可直接投入生产环境使用。

## 3. 逐步放开限流降级

随着 Redis 集群中缓存的数据越来越多，可以将限流或降级逐步放开，直至恢复到正常状态。

下面进行举例说明：

（1）在正常状态下，假设我们的系统将限流阈值设置为 5000，当 Redis 集群挂了的时候，我们将系统的限流阈值调整到了 1500。

当 Redis 新集群中的数据量恢复到正常状态下 20% 的时候，我们可以将系统的限流阈值调整到 2000；恢复到 40% 的时候，将系统的限流阈值调整到 2500……以此类推。

（2）我们系统中的功能等级，按照其重要程度分为 P0、P1、P2、P3 四个等级。当 Redis 集群挂了的时候，我们将系统降级到只支持 P0 等级的功能。

当 Redis 新集群中的数据量恢复到正常状态下 30% 的时候，我们可以将系统的降级策略调整到支持 P0 和 P1 等级；恢复到 60% 的时候，将系统的降级策略恢复到支持 P0、P1 和 P2 等级……以此类推。

另外，此时我们也要重点关注数据库服务器中的各种硬件指标，如：系统 Load、IOPS、CPU 利用率等等。




## 总结

其实对于“Redis 集群挂了”这个场景，首先需要规避的就是“回答姿势不对”的问题，造成被面试官一通追击连问的情况。

然后，我们还需要注意的就是，Redis 的两种持久化策略虽然可以进行数据恢复，但无法保证恢复后的数据是最新的业务数据。

最后再需要强调一下，我们系统中的限流和降级需要逐步放开，给 Redis 集群留下慢慢预热的时间，不要直接一蹴而就。